import { Injectable } from '@angular/core';
import { PopoverContentComponent } from '../components/popover-content/popover-content.component';
import { ActivePopover } from '../models/popover-active.model';
import { LayerAppendOptions } from '../../layer/layer.model';
import * as i0 from "@angular/core";
import * as i1 from "../../layer/layer.service";
import * as i2 from "./events.service";
export class PopoverService {
    constructor(layerService, eventsService) {
        this.layerService = layerService;
        this.eventsService = eventsService;
        this.activePopovers = [];
    }
    append(injector, directive, options, parentPopoverRef) {
        const existedPopover = this.activePopovers.find((popover) => popover.directiveRef === directive);
        if (options.closeOnTriggerAgain && existedPopover) {
            this.remove(existedPopover.popoverRef);
            return existedPopover.popoverRef;
        }
        else {
            return this.appendToBody(injector, directive, options, parentPopoverRef);
        }
    }
    remove(popoverRef) {
        const active = this.activePopovers.find((p) => p.popoverRef === popoverRef);
        if (active) {
            if (active.directiveRef) {
                active.directiveRef.popoverComponentRef = null;
                active.directiveRef.afterClose.emit();
            }
            active.popoverRef.destroy();
            this.layerService.removeFromBody(active.popoverRef);
            this.eventsService.unregister('click-outside', active);
            this.eventsService.unregister('capture-scroll', active);
            this.eventsService.unregister('resize', active);
            this.activePopovers = this.activePopovers.filter((a) => a.popoverRef !== popoverRef);
        }
    }
    removeByNativeElementRef(element) {
        const activePopover = this.activePopovers.find((active) => active.popoverRef.location.nativeElement === element);
        if (activePopover) {
            this.remove(activePopover.popoverRef);
        }
    }
    getActive(popoverRef) {
        return this.activePopovers.find((active) => active.popoverRef === popoverRef);
    }
    isPopoverSubmenuExits(precendingRef, parentRef) {
        const precendingActivePopover = this.getActive(precendingRef);
        if (!precendingActivePopover || (precendingActivePopover && !precendingActivePopover.deepLevel)) {
            return false;
        }
        return !!this.activePopovers.find((popover) => popover.parentPopoverRef === parentRef && popover.deepLevel === precendingActivePopover.deepLevel + 1);
    }
    removeAllNestedPopovers(popoverRef) {
        const activePopover = this.getActive(popoverRef);
        if (activePopover) {
            this.activePopovers
                .filter((popover) => popover.deepLevel > activePopover.deepLevel)
                .forEach((popover) => {
                this.remove(popover.popoverRef);
            });
        }
    }
    removeMenu(componentRef) {
        this.activePopovers
            .filter((popover) => popover.parentPopoverRef === componentRef || popover.popoverRef === componentRef)
            .forEach((popover) => {
            this.remove(popover.popoverRef);
        });
    }
    subscribeToClickOutsideEventForParentPopover(componentRef) {
        const currentPopover = this.getActive(componentRef);
        if (currentPopover) {
            const parentPopover = this.activePopovers.find((popover) => popover.superParentPopoverRef === currentPopover.superParentPopoverRef &&
                popover.deepLevel === currentPopover.deepLevel - 1);
            if (parentPopover) {
                setTimeout(() => {
                    this.eventsService.subscribe('click-outside', parentPopover);
                });
            }
        }
    }
    appendToBody(injector, directive, options, parentPopoverRef) {
        const layerOptions = new LayerAppendOptions({ delayClose: options.delayClose });
        const popover = this.layerService.appendToBody(PopoverContentComponent, layerOptions, injector);
        const { superparent, deepLevel } = this.prepareSuperparentAndDeepLevel(popover, parentPopoverRef, directive);
        const newPopover = new ActivePopover(popover, parentPopoverRef, superparent, directive, options.type, deepLevel);
        popover.instance.componentRef = popover;
        popover.instance.parentPopoverRef = popover;
        popover.changeDetectorRef.detectChanges();
        this.activePopovers.push(newPopover);
        if (newPopover.directiveRef) {
            newPopover.directiveRef.afterShow.emit();
        }
        if (this.canRegisterScrollCaptureEvent(newPopover, options)) {
            this.registerScrollCaptureEvent(newPopover, options);
        }
        if (this.canRegisterResizeEvent(newPopover, options)) {
            this.registerResizeEvent(newPopover, options);
        }
        return popover;
    }
    prepareSuperparentAndDeepLevel(popover, parentPopover, directive) {
        let deepLevel = 0;
        let superparent = null;
        if (directive) {
            const parentPopover = this.activePopovers.find((p) => {
                return p.popoverRef.instance.element.nativeElement.contains(directive.hostElement.nativeElement);
            });
            if (!parentPopover) {
                superparent = popover;
                deepLevel = 0;
            }
            else {
                superparent = parentPopover.superParentPopoverRef || parentPopover.popoverRef;
                deepLevel = parentPopover.deepLevel + 1;
            }
        }
        else {
            const closestParent = this.activePopovers.find((p) => p.popoverRef === parentPopover);
            if (closestParent) {
                const popoverGroup = this.activePopovers.filter((p) => p.superParentPopoverRef === closestParent.superParentPopoverRef);
                superparent = closestParent.superParentPopoverRef;
                deepLevel = popoverGroup[popoverGroup.length - 1].deepLevel + 1;
            }
        }
        return {
            deepLevel,
            superparent,
        };
    }
    canRegisterScrollCaptureEvent(popover, options) {
        const { triggeredBy, type, closeOnScroll } = options;
        return (popover.directiveRef &&
            popover.deepLevel === 0 &&
            triggeredBy !== 'hover' &&
            type !== 'submenu' &&
            closeOnScroll);
    }
    canRegisterResizeEvent(popover, options) {
        const { triggeredBy, type } = options;
        return popover.directiveRef && popover.deepLevel === 0 && triggeredBy !== 'hover' && type !== 'submenu';
    }
    registerResizeEvent(popover, options) {
        this.eventsService.register('resize', popover, () => {
            if (options.type === 'context') {
                this.hideGroup(popover);
            }
            else {
                this.updateGroupPosition(popover);
            }
        });
    }
    registerScrollCaptureEvent(popover, options) {
        this.eventsService.register('capture-scroll', popover, (event) => {
            const captured = popover.directiveRef.hostElement.nativeElement === event.target ||
                event.target.contains(popover.directiveRef.hostElement.nativeElement);
            if ((captured && options.hideOnScroll) || options.type === 'context') {
                this.hideGroup(popover);
            }
            if (captured && !options.hideOnScroll && options.type !== 'context') {
                this.updateGroupPosition(popover);
            }
        });
    }
    hideGroup(popover) {
        this.activePopovers.forEach((active) => {
            if (active.superParentPopoverRef === popover.superParentPopoverRef) {
                this.remove(active.popoverRef);
            }
        });
    }
    updateGroupPosition(popover) {
        this.activePopovers
            .filter((active) => active.superParentPopoverRef === popover.popoverRef)
            .forEach((active) => {
            if (active.popoverRef.instance.componentStyles) {
                active.popoverRef.instance.componentStyles.update();
            }
        });
    }
}
PopoverService.ɵfac = function PopoverService_Factory(t) { return new (t || PopoverService)(i0.ɵɵinject(i1.LayerService), i0.ɵɵinject(i2.PopoverEventsService)); };
PopoverService.ɵprov = i0.ɵɵdefineInjectable({ token: PopoverService, factory: PopoverService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(PopoverService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return [{ type: i1.LayerService }, { type: i2.PopoverEventsService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wb3Zlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL2ZvbHRpL1Byb2plY3RzL25nLXBvcHB5L3Byb2plY3RzL2xpYi9zcmMvIiwic291cmNlcyI6WyJsaWIvcG9wb3Zlci9zZXJ2aWNlcy9wb3BvdmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFnQixVQUFVLEVBQVksTUFBTSxlQUFlLENBQUM7QUFFbkUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0seURBQXlELENBQUM7QUFHbEcsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRS9ELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7O0FBTTdELE1BQU0sT0FBTyxjQUFjO0lBR3pCLFlBQW9CLFlBQTBCLEVBQVUsYUFBbUM7UUFBdkUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFGM0YsbUJBQWMsR0FBb0IsRUFBRSxDQUFDO0lBRXlELENBQUM7SUFFL0YsTUFBTSxDQUNKLFFBQWtCLEVBQ2xCLFNBQStCLEVBQy9CLE9BQTZCLEVBQzdCLGdCQUF3RDtRQUV4RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUMsQ0FBQztRQUVqRyxJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsSUFBSSxjQUFjLEVBQUU7WUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDdkMsT0FBTyxjQUFjLENBQUMsVUFBVSxDQUFDO1NBQ2xDO2FBQU07WUFDTCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztTQUMxRTtJQUNILENBQUM7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O2VBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IFBvcG92ZXJDb250ZW50Q29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9wb3BvdmVyLWNvbnRlbnQvcG9wb3Zlci1jb250ZW50LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBMYXllclNlcnZpY2UgfSBmcm9tICcuLi8uLi9sYXllci9sYXllci5zZXJ2aWNlJztcbmltcG9ydCB7IFBvcG92ZXJBcHBlbmRPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWxzL3BvcG92ZXItYXBwZW5kLW9wdGlvbnMubW9kZWwnO1xuaW1wb3J0IHsgQWN0aXZlUG9wb3ZlciB9IGZyb20gJy4uL21vZGVscy9wb3BvdmVyLWFjdGl2ZS5tb2RlbCc7XG5pbXBvcnQgeyBCYXNlUG9wb3ZlckRpcmVjdGl2ZSB9IGZyb20gJy4uL2RpcmVjdGl2ZXMvYmFzZS1wb3BvdmVyJztcbmltcG9ydCB7IExheWVyQXBwZW5kT3B0aW9ucyB9IGZyb20gJy4uLy4uL2xheWVyL2xheWVyLm1vZGVsJztcbmltcG9ydCB7IFBvcG92ZXJFdmVudHNTZXJ2aWNlIH0gZnJvbSAnLi9ldmVudHMuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBQb3BvdmVyU2VydmljZSB7XG4gIGFjdGl2ZVBvcG92ZXJzOiBBY3RpdmVQb3BvdmVyW10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxheWVyU2VydmljZTogTGF5ZXJTZXJ2aWNlLCBwcml2YXRlIGV2ZW50c1NlcnZpY2U6IFBvcG92ZXJFdmVudHNTZXJ2aWNlKSB7fVxuXG4gIGFwcGVuZChcbiAgICBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgZGlyZWN0aXZlOiBCYXNlUG9wb3ZlckRpcmVjdGl2ZSxcbiAgICBvcHRpb25zOiBQb3BvdmVyQXBwZW5kT3B0aW9ucyxcbiAgICBwYXJlbnRQb3BvdmVyUmVmPzogQ29tcG9uZW50UmVmPFBvcG92ZXJDb250ZW50Q29tcG9uZW50PlxuICApOiBDb21wb25lbnRSZWY8UG9wb3ZlckNvbnRlbnRDb21wb25lbnQ+IHtcbiAgICBjb25zdCBleGlzdGVkUG9wb3ZlciA9IHRoaXMuYWN0aXZlUG9wb3ZlcnMuZmluZCgocG9wb3ZlcikgPT4gcG9wb3Zlci5kaXJlY3RpdmVSZWYgPT09IGRpcmVjdGl2ZSk7XG5cbiAgICBpZiAob3B0aW9ucy5jbG9zZU9uVHJpZ2dlckFnYWluICYmIGV4aXN0ZWRQb3BvdmVyKSB7XG4gICAgICB0aGlzLnJlbW92ZShleGlzdGVkUG9wb3Zlci5wb3BvdmVyUmVmKTtcbiAgICAgIHJldHVybiBleGlzdGVkUG9wb3Zlci5wb3BvdmVyUmVmO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5hcHBlbmRUb0JvZHkoaW5qZWN0b3IsIGRpcmVjdGl2ZSwgb3B0aW9ucywgcGFyZW50UG9wb3ZlclJlZik7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKHBvcG92ZXJSZWY6IENvbXBvbmVudFJlZjxQb3BvdmVyQ29udGVudENvbXBvbmVudD4pOiB2b2lkIHtcbiAgICBjb25zdCBhY3RpdmU6IEFjdGl2ZVBvcG92ZXIgPSB0aGlzLmFjdGl2ZVBvcG92ZXJzLmZpbmQoKHApID0+IHAucG9wb3ZlclJlZiA9PT0gcG9wb3ZlclJlZik7XG5cbiAgICBpZiAoYWN0aXZlKSB7XG4gICAgICBpZiAoYWN0aXZlLmRpcmVjdGl2ZVJlZikge1xuICAgICAgICBhY3RpdmUuZGlyZWN0aXZlUmVmLnBvcG92ZXJDb21wb25lbnRSZWYgPSBudWxsO1xuICAgICAgICBhY3RpdmUuZGlyZWN0aXZlUmVmLmFmdGVyQ2xvc2UuZW1pdCgpO1xuICAgICAgfVxuICAgICAgYWN0aXZlLnBvcG92ZXJSZWYuZGVzdHJveSgpO1xuICAgICAgdGhpcy5sYXllclNlcnZpY2UucmVtb3ZlRnJvbUJvZHkoYWN0aXZlLnBvcG92ZXJSZWYpO1xuICAgICAgdGhpcy5ldmVudHNTZXJ2aWNlLnVucmVnaXN0ZXIoJ2NsaWNrLW91dHNpZGUnLCBhY3RpdmUpO1xuICAgICAgdGhpcy5ldmVudHNTZXJ2aWNlLnVucmVnaXN0ZXIoJ2NhcHR1cmUtc2Nyb2xsJywgYWN0aXZlKTtcbiAgICAgIHRoaXMuZXZlbnRzU2VydmljZS51bnJlZ2lzdGVyKCdyZXNpemUnLCBhY3RpdmUpO1xuXG4gICAgICB0aGlzLmFjdGl2ZVBvcG92ZXJzID0gdGhpcy5hY3RpdmVQb3BvdmVycy5maWx0ZXIoKGEpID0+IGEucG9wb3ZlclJlZiAhPT0gcG9wb3ZlclJlZik7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlQnlOYXRpdmVFbGVtZW50UmVmKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgYWN0aXZlUG9wb3ZlciA9IHRoaXMuYWN0aXZlUG9wb3ZlcnMuZmluZChcbiAgICAgIChhY3RpdmUpID0+IGFjdGl2ZS5wb3BvdmVyUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQgPT09IGVsZW1lbnRcbiAgICApO1xuXG4gICAgaWYgKGFjdGl2ZVBvcG92ZXIpIHtcbiAgICAgIHRoaXMucmVtb3ZlKGFjdGl2ZVBvcG92ZXIucG9wb3ZlclJlZik7XG4gICAgfVxuICB9XG5cbiAgZ2V0QWN0aXZlKHBvcG92ZXJSZWY6IENvbXBvbmVudFJlZjxQb3BvdmVyQ29udGVudENvbXBvbmVudD4pOiBBY3RpdmVQb3BvdmVyIHtcbiAgICByZXR1cm4gdGhpcy5hY3RpdmVQb3BvdmVycy5maW5kKChhY3RpdmUpID0+IGFjdGl2ZS5wb3BvdmVyUmVmID09PSBwb3BvdmVyUmVmKTtcbiAgfVxuXG4gIGlzUG9wb3ZlclN1Ym1lbnVFeGl0cyhcbiAgICBwcmVjZW5kaW5nUmVmOiBDb21wb25lbnRSZWY8UG9wb3ZlckNvbnRlbnRDb21wb25lbnQ+LFxuICAgIHBhcmVudFJlZjogQ29tcG9uZW50UmVmPFBvcG92ZXJDb250ZW50Q29tcG9uZW50PlxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCBwcmVjZW5kaW5nQWN0aXZlUG9wb3ZlcjogQWN0aXZlUG9wb3ZlciA9IHRoaXMuZ2V0QWN0aXZlKHByZWNlbmRpbmdSZWYpO1xuXG4gICAgaWYgKCFwcmVjZW5kaW5nQWN0aXZlUG9wb3ZlciB8fCAocHJlY2VuZGluZ0FjdGl2ZVBvcG92ZXIgJiYgIXByZWNlbmRpbmdBY3RpdmVQb3BvdmVyLmRlZXBMZXZlbCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gISF0aGlzLmFjdGl2ZVBvcG92ZXJzLmZpbmQoXG4gICAgICAocG9wb3ZlcikgPT5cbiAgICAgICAgcG9wb3Zlci5wYXJlbnRQb3BvdmVyUmVmID09PSBwYXJlbnRSZWYgJiYgcG9wb3Zlci5kZWVwTGV2ZWwgPT09IHByZWNlbmRpbmdBY3RpdmVQb3BvdmVyLmRlZXBMZXZlbCArIDFcbiAgICApO1xuICB9XG5cbiAgcmVtb3ZlQWxsTmVzdGVkUG9wb3ZlcnMocG9wb3ZlclJlZjogQ29tcG9uZW50UmVmPFBvcG92ZXJDb250ZW50Q29tcG9uZW50Pik6IHZvaWQge1xuICAgIGNvbnN0IGFjdGl2ZVBvcG92ZXIgPSB0aGlzLmdldEFjdGl2ZShwb3BvdmVyUmVmKTtcblxuICAgIGlmIChhY3RpdmVQb3BvdmVyKSB7XG4gICAgICB0aGlzLmFjdGl2ZVBvcG92ZXJzXG4gICAgICAgIC5maWx0ZXIoKHBvcG92ZXIpID0+IHBvcG92ZXIuZGVlcExldmVsID4gYWN0aXZlUG9wb3Zlci5kZWVwTGV2ZWwpXG4gICAgICAgIC5mb3JFYWNoKChwb3BvdmVyKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZW1vdmUocG9wb3Zlci5wb3BvdmVyUmVmKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlTWVudShjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxQb3BvdmVyQ29udGVudENvbXBvbmVudD4pOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2ZVBvcG92ZXJzXG4gICAgICAuZmlsdGVyKChwb3BvdmVyKSA9PiBwb3BvdmVyLnBhcmVudFBvcG92ZXJSZWYgPT09IGNvbXBvbmVudFJlZiB8fCBwb3BvdmVyLnBvcG92ZXJSZWYgPT09IGNvbXBvbmVudFJlZilcbiAgICAgIC5mb3JFYWNoKChwb3BvdmVyKSA9PiB7XG4gICAgICAgIHRoaXMucmVtb3ZlKHBvcG92ZXIucG9wb3ZlclJlZik7XG4gICAgICB9KTtcbiAgfVxuXG4gIHN1YnNjcmliZVRvQ2xpY2tPdXRzaWRlRXZlbnRGb3JQYXJlbnRQb3BvdmVyKGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPFBvcG92ZXJDb250ZW50Q29tcG9uZW50Pik6IHZvaWQge1xuICAgIGNvbnN0IGN1cnJlbnRQb3BvdmVyOiBBY3RpdmVQb3BvdmVyID0gdGhpcy5nZXRBY3RpdmUoY29tcG9uZW50UmVmKTtcblxuICAgIGlmIChjdXJyZW50UG9wb3Zlcikge1xuICAgICAgY29uc3QgcGFyZW50UG9wb3ZlcjogQWN0aXZlUG9wb3ZlciA9IHRoaXMuYWN0aXZlUG9wb3ZlcnMuZmluZChcbiAgICAgICAgKHBvcG92ZXIpID0+XG4gICAgICAgICAgcG9wb3Zlci5zdXBlclBhcmVudFBvcG92ZXJSZWYgPT09IGN1cnJlbnRQb3BvdmVyLnN1cGVyUGFyZW50UG9wb3ZlclJlZiAmJlxuICAgICAgICAgIHBvcG92ZXIuZGVlcExldmVsID09PSBjdXJyZW50UG9wb3Zlci5kZWVwTGV2ZWwgLSAxXG4gICAgICApO1xuXG4gICAgICBpZiAocGFyZW50UG9wb3Zlcikge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLmV2ZW50c1NlcnZpY2Uuc3Vic2NyaWJlKCdjbGljay1vdXRzaWRlJywgcGFyZW50UG9wb3Zlcik7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXBwZW5kVG9Cb2R5KFxuICAgIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBkaXJlY3RpdmU6IEJhc2VQb3BvdmVyRGlyZWN0aXZlLFxuICAgIG9wdGlvbnM6IFBvcG92ZXJBcHBlbmRPcHRpb25zLFxuICAgIHBhcmVudFBvcG92ZXJSZWY/OiBDb21wb25lbnRSZWY8UG9wb3ZlckNvbnRlbnRDb21wb25lbnQ+XG4gICk6IENvbXBvbmVudFJlZjxQb3BvdmVyQ29udGVudENvbXBvbmVudD4ge1xuICAgIGNvbnN0IGxheWVyT3B0aW9ucyA9IG5ldyBMYXllckFwcGVuZE9wdGlvbnMoeyBkZWxheUNsb3NlOiBvcHRpb25zLmRlbGF5Q2xvc2UgfSk7XG4gICAgY29uc3QgcG9wb3ZlciA9IHRoaXMubGF5ZXJTZXJ2aWNlLmFwcGVuZFRvQm9keShQb3BvdmVyQ29udGVudENvbXBvbmVudCwgbGF5ZXJPcHRpb25zLCBpbmplY3Rvcik7XG4gICAgY29uc3QgeyBzdXBlcnBhcmVudCwgZGVlcExldmVsIH0gPSB0aGlzLnByZXBhcmVTdXBlcnBhcmVudEFuZERlZXBMZXZlbChcbiAgICAgIHBvcG92ZXIsXG4gICAgICBwYXJlbnRQb3BvdmVyUmVmLFxuICAgICAgZGlyZWN0aXZlXG4gICAgKTtcbiAgICBjb25zdCBuZXdQb3BvdmVyID0gbmV3IEFjdGl2ZVBvcG92ZXIoXG4gICAgICBwb3BvdmVyLFxuICAgICAgcGFyZW50UG9wb3ZlclJlZixcbiAgICAgIHN1cGVycGFyZW50LFxuICAgICAgZGlyZWN0aXZlLFxuICAgICAgb3B0aW9ucy50eXBlLFxuICAgICAgZGVlcExldmVsXG4gICAgKTtcblxuICAgIHBvcG92ZXIuaW5zdGFuY2UuY29tcG9uZW50UmVmID0gcG9wb3ZlcjtcbiAgICBwb3BvdmVyLmluc3RhbmNlLnBhcmVudFBvcG92ZXJSZWYgPSBwb3BvdmVyO1xuICAgIHBvcG92ZXIuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgdGhpcy5hY3RpdmVQb3BvdmVycy5wdXNoKG5ld1BvcG92ZXIpO1xuXG4gICAgaWYgKG5ld1BvcG92ZXIuZGlyZWN0aXZlUmVmKSB7XG4gICAgICBuZXdQb3BvdmVyLmRpcmVjdGl2ZVJlZi5hZnRlclNob3cuZW1pdCgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNhblJlZ2lzdGVyU2Nyb2xsQ2FwdHVyZUV2ZW50KG5ld1BvcG92ZXIsIG9wdGlvbnMpKSB7XG4gICAgICB0aGlzLnJlZ2lzdGVyU2Nyb2xsQ2FwdHVyZUV2ZW50KG5ld1BvcG92ZXIsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNhblJlZ2lzdGVyUmVzaXplRXZlbnQobmV3UG9wb3Zlciwgb3B0aW9ucykpIHtcbiAgICAgIHRoaXMucmVnaXN0ZXJSZXNpemVFdmVudChuZXdQb3BvdmVyLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcG9wb3ZlcjtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZVN1cGVycGFyZW50QW5kRGVlcExldmVsKFxuICAgIHBvcG92ZXI6IENvbXBvbmVudFJlZjxQb3BvdmVyQ29udGVudENvbXBvbmVudD4sXG4gICAgcGFyZW50UG9wb3ZlcjogQ29tcG9uZW50UmVmPFBvcG92ZXJDb250ZW50Q29tcG9uZW50PixcbiAgICBkaXJlY3RpdmU6IEJhc2VQb3BvdmVyRGlyZWN0aXZlXG4gICk6IHsgZGVlcExldmVsOiBudW1iZXI7IHN1cGVycGFyZW50OiBDb21wb25lbnRSZWY8UG9wb3ZlckNvbnRlbnRDb21wb25lbnQ+IH0ge1xuICAgIGxldCBkZWVwTGV2ZWwgPSAwO1xuICAgIGxldCBzdXBlcnBhcmVudCA9IG51bGw7XG5cbiAgICBpZiAoZGlyZWN0aXZlKSB7XG4gICAgICBjb25zdCBwYXJlbnRQb3BvdmVyID0gdGhpcy5hY3RpdmVQb3BvdmVycy5maW5kKChwKSA9PiB7XG4gICAgICAgIHJldHVybiBwLnBvcG92ZXJSZWYuaW5zdGFuY2UuZWxlbWVudC5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGRpcmVjdGl2ZS5ob3N0RWxlbWVudC5uYXRpdmVFbGVtZW50KTtcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXBhcmVudFBvcG92ZXIpIHtcbiAgICAgICAgc3VwZXJwYXJlbnQgPSBwb3BvdmVyO1xuICAgICAgICBkZWVwTGV2ZWwgPSAwO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3VwZXJwYXJlbnQgPSBwYXJlbnRQb3BvdmVyLnN1cGVyUGFyZW50UG9wb3ZlclJlZiB8fCBwYXJlbnRQb3BvdmVyLnBvcG92ZXJSZWY7XG4gICAgICAgIGRlZXBMZXZlbCA9IHBhcmVudFBvcG92ZXIuZGVlcExldmVsICsgMTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY2xvc2VzdFBhcmVudCA9IHRoaXMuYWN0aXZlUG9wb3ZlcnMuZmluZCgocCkgPT4gcC5wb3BvdmVyUmVmID09PSBwYXJlbnRQb3BvdmVyKTtcbiAgICAgIGlmIChjbG9zZXN0UGFyZW50KSB7XG4gICAgICAgIGNvbnN0IHBvcG92ZXJHcm91cCA9IHRoaXMuYWN0aXZlUG9wb3ZlcnMuZmlsdGVyKFxuICAgICAgICAgIChwKSA9PiBwLnN1cGVyUGFyZW50UG9wb3ZlclJlZiA9PT0gY2xvc2VzdFBhcmVudC5zdXBlclBhcmVudFBvcG92ZXJSZWZcbiAgICAgICAgKTtcbiAgICAgICAgc3VwZXJwYXJlbnQgPSBjbG9zZXN0UGFyZW50LnN1cGVyUGFyZW50UG9wb3ZlclJlZjtcbiAgICAgICAgZGVlcExldmVsID0gcG9wb3Zlckdyb3VwW3BvcG92ZXJHcm91cC5sZW5ndGggLSAxXS5kZWVwTGV2ZWwgKyAxO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBkZWVwTGV2ZWwsXG4gICAgICBzdXBlcnBhcmVudCxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5SZWdpc3RlclNjcm9sbENhcHR1cmVFdmVudChwb3BvdmVyOiBBY3RpdmVQb3BvdmVyLCBvcHRpb25zOiBQb3BvdmVyQXBwZW5kT3B0aW9ucyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgdHJpZ2dlcmVkQnksIHR5cGUsIGNsb3NlT25TY3JvbGwgfSA9IG9wdGlvbnM7XG5cbiAgICByZXR1cm4gKFxuICAgICAgcG9wb3Zlci5kaXJlY3RpdmVSZWYgJiZcbiAgICAgIHBvcG92ZXIuZGVlcExldmVsID09PSAwICYmXG4gICAgICB0cmlnZ2VyZWRCeSAhPT0gJ2hvdmVyJyAmJlxuICAgICAgdHlwZSAhPT0gJ3N1Ym1lbnUnICYmXG4gICAgICBjbG9zZU9uU2Nyb2xsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FuUmVnaXN0ZXJSZXNpemVFdmVudChwb3BvdmVyOiBBY3RpdmVQb3BvdmVyLCBvcHRpb25zOiBQb3BvdmVyQXBwZW5kT3B0aW9ucyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgdHJpZ2dlcmVkQnksIHR5cGUgfSA9IG9wdGlvbnM7XG5cbiAgICByZXR1cm4gcG9wb3Zlci5kaXJlY3RpdmVSZWYgJiYgcG9wb3Zlci5kZWVwTGV2ZWwgPT09IDAgJiYgdHJpZ2dlcmVkQnkgIT09ICdob3ZlcicgJiYgdHlwZSAhPT0gJ3N1Ym1lbnUnO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlclJlc2l6ZUV2ZW50KHBvcG92ZXI6IEFjdGl2ZVBvcG92ZXIsIG9wdGlvbnM6IFBvcG92ZXJBcHBlbmRPcHRpb25zKTogdm9pZCB7XG4gICAgdGhpcy5ldmVudHNTZXJ2aWNlLnJlZ2lzdGVyKCdyZXNpemUnLCBwb3BvdmVyLCAoKSA9PiB7XG4gICAgICBpZiAob3B0aW9ucy50eXBlID09PSAnY29udGV4dCcpIHtcbiAgICAgICAgdGhpcy5oaWRlR3JvdXAocG9wb3Zlcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnVwZGF0ZUdyb3VwUG9zaXRpb24ocG9wb3Zlcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyU2Nyb2xsQ2FwdHVyZUV2ZW50KHBvcG92ZXI6IEFjdGl2ZVBvcG92ZXIsIG9wdGlvbnM6IFBvcG92ZXJBcHBlbmRPcHRpb25zKTogdm9pZCB7XG4gICAgdGhpcy5ldmVudHNTZXJ2aWNlLnJlZ2lzdGVyKCdjYXB0dXJlLXNjcm9sbCcsIHBvcG92ZXIsIChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgICAgY29uc3QgY2FwdHVyZWQgPVxuICAgICAgICBwb3BvdmVyLmRpcmVjdGl2ZVJlZi5ob3N0RWxlbWVudC5uYXRpdmVFbGVtZW50ID09PSBldmVudC50YXJnZXQgfHxcbiAgICAgICAgKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY29udGFpbnMocG9wb3Zlci5kaXJlY3RpdmVSZWYuaG9zdEVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG5cbiAgICAgIGlmICgoY2FwdHVyZWQgJiYgb3B0aW9ucy5oaWRlT25TY3JvbGwpIHx8IG9wdGlvbnMudHlwZSA9PT0gJ2NvbnRleHQnKSB7XG4gICAgICAgIHRoaXMuaGlkZUdyb3VwKHBvcG92ZXIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2FwdHVyZWQgJiYgIW9wdGlvbnMuaGlkZU9uU2Nyb2xsICYmIG9wdGlvbnMudHlwZSAhPT0gJ2NvbnRleHQnKSB7XG4gICAgICAgIHRoaXMudXBkYXRlR3JvdXBQb3NpdGlvbihwb3BvdmVyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGlkZUdyb3VwKHBvcG92ZXI6IEFjdGl2ZVBvcG92ZXIpOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2ZVBvcG92ZXJzLmZvckVhY2goKGFjdGl2ZSkgPT4ge1xuICAgICAgaWYgKGFjdGl2ZS5zdXBlclBhcmVudFBvcG92ZXJSZWYgPT09IHBvcG92ZXIuc3VwZXJQYXJlbnRQb3BvdmVyUmVmKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlKGFjdGl2ZS5wb3BvdmVyUmVmKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlR3JvdXBQb3NpdGlvbihwb3BvdmVyOiBBY3RpdmVQb3BvdmVyKTogdm9pZCB7XG4gICAgdGhpcy5hY3RpdmVQb3BvdmVyc1xuICAgICAgLmZpbHRlcigoYWN0aXZlKSA9PiBhY3RpdmUuc3VwZXJQYXJlbnRQb3BvdmVyUmVmID09PSBwb3BvdmVyLnBvcG92ZXJSZWYpXG4gICAgICAuZm9yRWFjaCgoYWN0aXZlKSA9PiB7XG4gICAgICAgIGlmIChhY3RpdmUucG9wb3ZlclJlZi5pbnN0YW5jZS5jb21wb25lbnRTdHlsZXMpIHtcbiAgICAgICAgICBhY3RpdmUucG9wb3ZlclJlZi5pbnN0YW5jZS5jb21wb25lbnRTdHlsZXMudXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG59XG4iXX0=